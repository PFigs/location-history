dist: bionic
language: python
python:
   - 3.7

before_install:
  - sudo gem install github_changelog_generator &
  - pip install -r dev-requirements.txt
  - flake8 timemap
  - black --check timemap

install:
  - pip install .

script:
   - pytest

jobs:
  include:
    - stage: changelog_creation
      script: github_changelog_generator -t ${GITHUB_TOKEN}
      on:
        tags: true

deploy:
  - provider: releases
    api_key: ${GITHUB_TOKEN}
    file_glob: true
    file:
      - ./dist/*
      - CHANGELOG.md
    skip_cleanup: true
    on:
      tags: true
      branch: master

  - provider: pypi
    user: ${TWINE_USERNAME}
    password: ${TWINE_PASSWORD}
    skip_existing: true
    skip_cleanup: true
    distributions: "sdist bdist_wheel"
    on:
      tags: true
      branch: master

